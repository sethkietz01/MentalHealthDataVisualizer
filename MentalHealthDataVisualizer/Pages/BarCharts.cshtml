@page
@using MentalHealthDataVisualizer.Models
@model MentalHealthDataVisualizer.Models.BarChartsModel
@{

    // Sort data by demographic and sum the tallies 
    var demographicData = Model.AmiPrevalenceData
        .GroupBy(d => d.demographic)
        .Select(g => new
        {
            Demographic = g.Key,
            TotalTally = g.Sum(d => d.tally)
        })
        .ToList();

    // Extract data to lists
    var demographicLabels = demographicData.Select(d => d.Demographic).ToList();
    var demographicValues = demographicData.Select(d => d.TotalTally).ToList();

    // Convert lists to JSON 
    var demographicLabelsJson = System.Text.Json.JsonSerializer.Serialize(demographicLabels);
    var demographicValuesJson = System.Text.Json.JsonSerializer.Serialize(demographicValues);


    // Sort data by age category and sum the tallies
    var ageCategoryData = Model.AmiPrevalenceData
        .Where(d => !string.IsNullOrEmpty(d.age_category)) 
        .GroupBy(d => d.age_category)
        .Select(g => new
        {
            AgeCategory = g.Key,
            TotalTally = g.Sum(d => d.tally)
        })
        .OrderBy(d => d.AgeCategory) 
        .ToList();

    // Extract data to lists
    var ageCategoryLabels = ageCategoryData.Select(d => d.AgeCategory).ToList();
    var ageCategoryValues = ageCategoryData.Select(d => d.TotalTally).ToList();

    // Convert lists to JSON
    var ageCategoryLabelsJson = System.Text.Json.JsonSerializer.Serialize(ageCategoryLabels);
    var ageCategoryValuesJson = System.Text.Json.JsonSerializer.Serialize(ageCategoryValues);
}

<h1>@ViewData["Title"]</h1>

<div class="row">
    <div class="col-md-6">
        <h3>AMI Tally by Demographic</h3>
        <div class="chart-container" style="height:350px;">
            <canvas id="demographicChart"></canvas>
        </div>
    </div>

    <div class="col-md-6">
        <h3>AMI Tally by Age Category</h3>
        <div class="chart-container" style="height:350px;">
            <canvas id="yearChart"></canvas>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // Inject JSON
        const demographicLabels = @Html.Raw(demographicLabelsJson);
        const demographicValues = @Html.Raw(demographicValuesJson);
        
        // Set up demographic chart data
        const demographicData = {
            labels: demographicLabels,
            datasets: [{
                label: 'Total AMI Tally',
                data: demographicValues,
                backgroundColor: 'rgba(75, 192, 192, 0.7)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        };

        // Configure demographic bar chart
        const demographicConfig = {
            type: 'bar',
            data: demographicData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Total Tally' }
                    },
                    x: {
                        title: { display: true, text: 'Demographic Category' }
                    }
                }
            }
        };

        // Instantiate demographic chart
        new Chart(
            document.getElementById('demographicChart'),
            demographicConfig
        );


        // Inject JSON
        const yearLabels = @Html.Raw(ageCategoryLabelsJson); 
        const yearValues = @Html.Raw(ageCategoryValuesJson); 

        // Set up year chart data
        const yearData = {
            labels: yearLabels,
            datasets: [{
                label: 'Total AMI Tally',
                data: yearValues,
                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                borderColor: 'rgba(255, 99, 132, 1)',
                borderWidth: 1
            }]
        };

        // Configure year bar chart
        const yearConfig = {
            type: 'bar',
            data: yearData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Total Tally' }
                    },
                    x: {
                        title: { display: true, text: 'Age Category' }
                    }
                }
            }
        };

        // Instantiate year chart
        new Chart(
            document.getElementById('yearChart'),
            yearConfig
        );
    </script>
}